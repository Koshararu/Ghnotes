import requests
from bs4 import BeautifulSoup
from hikka import loader, utils

class PixivImageDownloaderMod(loader.Module):
    """Модуль для скачивания изображений с Pixiv и отправки их в чат"""
    strings = {"name": "PixivImageDownloader"}

    async def pixivcmd(self, message):
        """Используйте .pixiv <URL> для скачивания и отправки изображения с Pixiv"""
        args = utils.get_args_raw(message)
        if not args:
            await message.edit("<b>Пожалуйста, укажите URL изображения с Pixiv.</b>")
            return

        url = args.strip()
        await message.edit("<b>Скачиваю изображение...</b>")
        
        try:
            image_path = self.download_image(url)
            await message.client.send_file(message.to_id, image_path)
            await message.delete()
        except Exception as e:
            await message.edit(f"<b>Ошибка при скачивании изображения: {e}</b>")

    def download_image(self, url):
        headers = {
            'Referer': 'https://www.pixiv.net/',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        }
        response = requests.get(url, headers=headers)
        soup = BeautifulSoup(response.content, 'html.parser')
        img_url = soup.find('meta', property='og:image')['content']
        img_data = requests.get(img_url, headers=headers).content
        image_path = 'image.jpg'
        with open(image_path, 'wb') as handler:
            handler.write(img_data)
        return image_path
